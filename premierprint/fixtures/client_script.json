[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-12-22 16:20:41.759048",
  "module": null,
  "name": "Stock Entry - hide options",
  "script": "frappe.ui.form.on('Stock Entry', {\n    // 1. SETUP: Form ochilishi bilan filtrlarni o'rnatamiz\n    setup: function(frm) {\n        frm.set_query('stock_entry_type', function() {\n            return {\n                filters: [\n                    ['Stock Entry Type', 'name', 'in', ['Расход по заказу', 'Услуги по заказу', 'Перемещение']]\n                ]\n            };\n        });\n    },\n\n    // 2. REFRESH: Form yuklanganda logikani ishlatamiz\n    refresh: function(frm) {\n        frm.trigger('apply_ui_rules');\n    },\n\n    // 3. O'ZGARISH: Tip o'zgarganda logikani ishlatamiz\n    stock_entry_type: function(frm) {\n        frm.trigger('apply_ui_rules');\n    },\n\n    // 4. MANTIQ MARKAZI\n    apply_ui_rules: function(frm) {\n        let type = frm.doc.stock_entry_type;\n\n        // Reset (Avval hammasini tozalaymiz/yashiramiz)\n        // Bu juda muhim, aks holda eski holat qotib qoladi\n        frm.set_df_property('custom_supplier', 'hidden', 1);\n        frm.set_df_property('custom_supplier', 'reqd', 0);\n        frm.fields_dict['items'].grid.update_docfield_property('basic_rate', 'hidden', 0);\n        frm.fields_dict['items'].grid.update_docfield_property('basic_rate', 'read_only', 0);\n        frm.fields_dict['items'].grid.update_docfield_property('amount', 'hidden', 0);\n\n        // A) \"Услуги по заказу\"\n        if (type === 'Услуги по заказу') {\n            // Supplier majburiy\n            frm.set_df_property('custom_supplier', 'hidden', 0);\n            frm.set_df_property('custom_supplier', 'reqd', 1);\n        } \n        \n        // B) \"Расход по заказу\"\n        else if (type === 'Расход по заказу') {\n            // Narxlar yashirinadi (Maxfiylik)\n            frm.fields_dict['items'].grid.update_docfield_property('basic_rate', 'hidden', 1);\n            frm.fields_dict['items'].grid.update_docfield_property('amount', 'hidden', 1);\n        } \n        \n        // C) \"Перемещение\" (Yangi qo'shilgan)\n        else if (type === 'Перемещение') {\n            // Narx ko'rinsin, lekin o'zgartirib bo'lmasin\n            frm.fields_dict['items'].grid.update_docfield_property('basic_rate', 'read_only', 1);\n        }\n        \n        // Jadvalni yangilash\n        frm.refresh_field('items');\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-12-22 17:12:39.108549",
  "module": null,
  "name": "stock entry - add item",
  "script": "frappe.ui.form.on('Stock Entry', {\n    setup: function(frm) {\n        // 1. Stock Entry Type filtri\n        frm.set_query('stock_entry_type', function() {\n            return {\n                filters: [\n                    ['Stock Entry Type', 'name', 'in', ['Расход по заказу', 'Услуги по заказу', 'Перемещение']]\n                ]\n            };\n        });\n\n        // 2. Sales Order Item Query (BOM uchun)\n        frm.set_query(\"custom_sales_order_item\", function() {\n            let so_id = frm.doc.custom_sales_order;\n            if (!so_id) return { filters: { \"parent\": \"null\" } };\n            return {\n                query: \"premierprint.premierprint.utils.stock_entry.get_sales_order_items_query\",\n                filters: { \"sales_order\": so_id }\n            };\n        });\n\n        // 3. Omborlarni Filtrlash (JADVAL ICHIDA)\n        frm.set_query(\"s_warehouse\", \"items\", function(doc, cdt, cdn) {\n            if (frm.doc.stock_entry_type === 'Перемещение' && frm.doc.custom_from_sub_company) {\n                return get_warehouse_filter(frm.doc.custom_from_sub_company);\n            }\n        });\n\n        frm.set_query(\"t_warehouse\", \"items\", function(doc, cdt, cdn) {\n            if (frm.doc.stock_entry_type === 'Перемещение' && frm.doc.custom_to_sub_company) {\n                return get_warehouse_filter(frm.doc.custom_to_sub_company);\n            }\n        });\n    },\n\n    refresh: function(frm) {\n        frm.trigger('apply_ui_rules');\n    },\n\n    stock_entry_type: function(frm) {\n        frm.trigger('apply_ui_rules');\n    },\n\n    // Sub Company o'zgarganda filtrlarni yangilash\n    custom_from_sub_company: function(frm) { frm.refresh_field('items'); },\n    custom_to_sub_company: function(frm) { frm.refresh_field('items'); },\n\n    // Sales Order o'zgarganda\n    custom_sales_order: function(frm) {\n        frm.set_value(\"custom_sales_order_item\", \"\");\n        frm.clear_table(\"items\");\n        frm.refresh_field(\"items\");\n    },\n\n    // Item tanlanganda (BOM yuklash)\n    custom_sales_order_item: function(frm) {\n        if (frm.doc.custom_sales_order_item) {\n            frm.clear_table(\"items\");\n            frm.refresh_field(\"items\");\n\n            frappe.call({\n                method: \"premierprint.premierprint.utils.stock_entry.get_bom_materials\",\n                args: { sales_order_item_id: frm.doc.custom_sales_order_item },\n                freeze: true,\n                callback: function(r) {\n                    if (r.message && r.message.length > 0) {\n                        r.message.forEach(row => {\n                            let child = frm.add_child(\"items\");\n                            frappe.model.set_value(child.doctype, child.name, row);\n                        });\n                        frm.refresh_field(\"items\");\n                    }\n                    frm.trigger('apply_ui_rules'); // UI qoidalarini qayta qo'llash\n                }\n            });\n        }\n    },\n\n    // --- UI MANTIQ MARKAZI ---\n    apply_ui_rules: function(frm) {\n        let type = frm.doc.stock_entry_type;\n\n        // RESET\n        frm.set_df_property('custom_supplier', 'hidden', 1);\n        frm.set_df_property('custom_supplier', 'reqd', 0);\n        frm.set_df_property('custom_from_sub_company', 'hidden', 1);\n        frm.set_df_property('custom_to_sub_company', 'hidden', 1);\n        frm.set_df_property('custom_from_sub_company', 'reqd', 0);\n        frm.set_df_property('custom_to_sub_company', 'reqd', 0);\n        frm.fields_dict['items'].grid.update_docfield_property('basic_rate', 'hidden', 0);\n        frm.fields_dict['items'].grid.update_docfield_property('basic_rate', 'read_only', 1);\n        frm.fields_dict['items'].grid.update_docfield_property('amount', 'hidden', 0);\n\n        // LOGIKA\n        if (type === 'Услуги по заказу') {\n            frm.set_df_property('custom_supplier', 'hidden', 0);\n            frm.set_df_property('custom_supplier', 'reqd', 1);\n            frm.fields_dict['items'].grid.update_docfield_property('basic_rate', 'read_only', 0);\n        } \n        else if (type === 'Расход по заказу') {\n            frm.fields_dict['items'].grid.update_docfield_property('basic_rate', 'hidden', 1);\n            frm.fields_dict['items'].grid.update_docfield_property('amount', 'hidden', 1);\n        } \n        else if (type === 'Перемещение') {\n            frm.set_df_property('custom_from_sub_company', 'hidden', 0);\n            frm.set_df_property('custom_to_sub_company', 'hidden', 0);\n            frm.set_df_property('custom_from_sub_company', 'reqd', 1);\n            frm.set_df_property('custom_to_sub_company', 'reqd', 1);\n        }\n        \n        frm.refresh_field('items');\n    }\n});\n\n// YORDAMCHI FUNKSIYALAR\nfunction get_warehouse_filter(sub_company) {\n    let filter_txt = \"\";\n    if (sub_company === \"Полиграфия\") filter_txt = \"Poli\";\n    else if (sub_company === \"Реклама\") filter_txt = \"Reklama\";\n    else if (sub_company === \"Сувенир\") filter_txt = \"Suvenir\";\n\n    return { filters: [['Warehouse', 'name', 'like', '%' + filter_txt + '%']] };\n}\n\nfrappe.ui.form.on('Stock Entry Detail', {\n    s_warehouse: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        if (row.s_warehouse) set_cost_center(frm, row);\n    },\n    t_warehouse: function(frm, cdt, cdn) {\n        let row = locals[cdt][cdn];\n        if (row.t_warehouse) set_cost_center(frm, row);\n    }\n});\n\nfunction set_cost_center(frm, row) {\n    let warehouse = row.s_warehouse || row.t_warehouse;\n    if (!warehouse) return;\n\n    if (warehouse.includes(\"Poli\")) {\n        frappe.model.set_value(row.doctype, row.name, \"cost_center\", \"100 - Poligrafiya Department\");\n    } else if (warehouse.includes(\"Reklama\")) {\n        frappe.model.set_value(row.doctype, row.name, \"cost_center\", \"200 - Reklama Department\");\n    } else if (warehouse.includes(\"Suvenir\")) {\n        frappe.model.set_value(row.doctype, row.name, \"cost_center\", \"300 - Suvenir Department\");\n    }\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-12-16 17:45:03.598740",
  "module": "Primier Print",
  "name": "Purchase Order",
  "script": "frappe.ui.form.on(\"Purchase Order\", {\n    before_save(frm) {\n        (frm.doc.items || []).forEach(row => {\n            if (!row.schedule_date) {\n                row.schedule_date = frappe.datetime.get_today();\n            }\n        });\n    },\n\n    refresh(frm) {\n        if (frm.fields_dict.items?.grid) {\n            const grid = frm.fields_dict.items.grid;\n\n            // faqat yashiramiz\n            grid.update_docfield_property(\"schedule_date\", \"hidden\", 1);\n            grid.update_docfield_property(\"schedule_date\", \"reqd\", 0);\n\n            grid.refresh();\n        }\n    }\n});\n\n",
  "view": "Form"
 }
]