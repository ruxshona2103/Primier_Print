[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2025-12-16 17:45:03.598740",
  "module": "Primier Print",
  "name": "Purchase Order",
  "script": "frappe.ui.form.on(\"Purchase Order\", {\n    before_save(frm) {\n        (frm.doc.items || []).forEach(row => {\n            if (!row.schedule_date) {\n                row.schedule_date = frappe.datetime.get_today();\n            }\n        });\n    },\n\n    refresh(frm) {\n        if (frm.fields_dict.items?.grid) {\n            const grid = frm.fields_dict.items.grid;\n\n            // faqat yashiramiz\n            grid.update_docfield_property(\"schedule_date\", \"hidden\", 1);\n            grid.update_docfield_property(\"schedule_date\", \"reqd\", 0);\n\n            grid.refresh();\n        }\n    }\n});\n\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Stock Entry",
  "enabled": 1,
  "modified": "2025-12-24 21:09:45.046107",
  "module": null,
  "name": "Stock Entry - Optimized Logic",
  "script": "frappe.ui.form.on('Stock Entry', {\n    setup: function(frm) {\n        // 1. Stock Entry Type filtri\n        frm.set_query('stock_entry_type', function() {\n            return {\n                filters: [\n                    ['Stock Entry Type', 'name', 'in', ['Расход по заказу', 'Услуги по заказу', 'Перемещение']]\n                ]\n            };\n        });\n\n        // 2. Sales Order Item Query\n        frm.set_query(\"custom_sales_order_item\", function() {\n            let so_id = frm.doc.custom_sales_order;\n            if (!so_id) return { filters: { \"parent\": \"null\" } };\n            return {\n                query: \"premierprint.premierprint.utils.stock_entry.get_sales_order_items_query\",\n                filters: { \"sales_order\": so_id }\n            };\n        });\n    },\n\n    refresh: function(frm) {\n        // Jadval ichidagi filtrlarni \"Jarrohlik\" yo'li bilan o'rnatamiz\n        // Bu usul standart ERPNext filtrlarini bosib o'tadi\n        frm.fields_dict['items'].grid.get_field('t_warehouse').get_query = function(doc, cdt, cdn) {\n            // DEBUG: Konsolda ishlaganini tekshirish uchun\n            console.log(\"Target Filter Ishladi! Nishon:\", doc.custom_to_sub_company);\n\n            // Agar \"Перемещение\" bo'lsa va Nishon kompaniya tanlangan bo'lsa\n            if (doc.stock_entry_type === 'Перемещение' && doc.custom_to_sub_company) {\n                return {\n                    filters: {\n                        'company': doc.custom_to_sub_company, // <--- REKLAMA shu yerdan olinadi\n                        'is_group': 0\n                    }\n                };\n            }\n            \n            // Boshqa payt -> Standart Company\n            return {\n                filters: {\n                    'company': doc.company,\n                    'is_group': 0\n                }\n            };\n        };\n\n        // Source Warehouse uchun ham xuddi shunday\n        frm.fields_dict['items'].grid.get_field('s_warehouse').get_query = function(doc, cdt, cdn) {\n            return {\n                filters: {\n                    'company': doc.company, // Manba doim asosiy Company\n                    'is_group': 0\n                }\n            };\n        };\n\n        frm.trigger('apply_ui_rules');\n    },\n\n    stock_entry_type: function(frm) {\n        frm.trigger('apply_ui_rules');\n    },\n\n    // Kompaniya o'zgarganda\n    company: function(frm) {\n        frm.clear_table(\"items\");\n        frm.refresh_field('items');\n    },\n\n    // Nishon kompaniya o'zgarganda -> Jadvalni yangilash\n    custom_to_sub_company: function(frm) { \n        // Qatorlarni tozalash shart emas, lekin Refresh kerak\n        frm.refresh_field('items'); \n    },\n\n    custom_sales_order: function(frm) {\n        frm.set_value(\"custom_sales_order_item\", \"\");\n        frm.clear_table(\"items\");\n        frm.refresh_field(\"items\");\n    },\n\n    // BOM YUKLASH\n    custom_sales_order_item: function(frm) {\n        if (frm.doc.custom_sales_order_item) {\n            frm.clear_table(\"items\");\n            frm.refresh_field(\"items\");\n\n            frappe.call({\n                method: \"premierprint.premierprint.utils.stock_entry.get_bom_materials\",\n                args: { sales_order_item_id: frm.doc.custom_sales_order_item },\n                freeze: true,\n                callback: function(r) {\n                    if (r.message && r.message.length > 0) {\n                        r.message.forEach(function(row) {\n                            let child = frm.add_child(\"items\");\n                            frappe.model.set_value(child.doctype, child.name, row);\n                        });\n                        frm.refresh_field(\"items\");\n                        frm.trigger('apply_ui_rules');\n                    } else {\n                        frappe.msgprint(\"BOM topilmadi. Materiallarni qo'lda kiriting.\");\n                    }\n                }\n            });\n        }\n    },\n\n    apply_ui_rules: function(frm) {\n        let type = frm.doc.stock_entry_type;\n\n        // RESET\n        frm.set_df_property('custom_supplier', 'hidden', 1);\n        frm.set_df_property('custom_supplier', 'reqd', 0);\n        \n        frm.set_df_property('custom_from_sub_company', 'hidden', 1); // O'lik maydon\n        frm.set_df_property('custom_to_sub_company', 'hidden', 1);\n        frm.set_df_property('custom_to_sub_company', 'reqd', 0);\n\n        frm.set_df_property('custom_sales_order', 'hidden', 0);\n        frm.set_df_property('custom_sales_order_item', 'hidden', 0);\n\n        frm.fields_dict['items'].grid.update_docfield_property('basic_rate', 'hidden', 0);\n        frm.fields_dict['items'].grid.update_docfield_property('basic_rate', 'read_only', 1);\n        frm.fields_dict['items'].grid.update_docfield_property('amount', 'hidden', 0);\n\n        // LOGIKA\n        if (type === 'Услуги по заказу') {\n            frm.set_df_property('custom_supplier', 'hidden', 0);\n            frm.set_df_property('custom_supplier', 'reqd', 1);\n            frm.fields_dict['items'].grid.update_docfield_property('basic_rate', 'read_only', 0);\n        } \n        else if (type === 'Расход по заказу') {\n            frm.fields_dict['items'].grid.update_docfield_property('basic_rate', 'hidden', 1);\n            frm.fields_dict['items'].grid.update_docfield_property('amount', 'hidden', 1);\n        } \n        else if (type === 'Перемещение') {\n            frm.set_df_property('custom_sales_order', 'hidden', 1);\n            frm.set_df_property('custom_sales_order_item', 'hidden', 1);\n            \n            // To Sub Company ochiladi\n            frm.set_df_property('custom_to_sub_company', 'hidden', 0);\n            frm.set_df_property('custom_to_sub_company', 'reqd', 1);\n        }\n        \n        frm.refresh_field('items');\n    }\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Payment Entry",
  "enabled": 1,
  "modified": "2025-12-24 21:19:02.084488",
  "module": null,
  "name": "Payment Entry - Expenses Support",
  "script": "frappe.ui.form.on('Payment Entry', {\n    onload: function(frm) {\n        // Party Type ga Expenses option qo'shamiz\n        let options = frm.fields_dict['party_type'].df.options;\n        if (typeof options === 'string') {\n            options = options.split('\\n');\n        }\n        if (!options.includes('Expenses')) {\n            options.push('Expenses');\n        }\n        frm.fields_dict['party_type'].df.options = options;\n        frm.refresh_field('party_type');\n    },\n\n    party_type: function(frm) {\n        if (frm.doc.party_type === 'Expenses') {\n            // Party field ni Expense Category ga o'zgartiramiz\n            frm.set_df_property('party', 'label', 'Категория расхода');\n            frm.set_df_property('party', 'options', 'Expense Category');\n            frm.set_df_property('party', 'reqd', 1);\n            frm.set_df_property('party_name', 'hidden', 1);\n\n            // Tozalash\n            frm.set_value('party', '');\n            frm.set_value('party_name', '');\n        } else {\n            // Oddiy holatga qaytarish\n            frm.set_df_property('party', 'label', 'Party');\n            frm.set_df_property('party_name', 'hidden', 0);\n\n            // Options ni tiklash\n            if (frm.doc.party_type === 'Customer') {\n                frm.set_df_property('party', 'options', 'Customer');\n            } else if (frm.doc.party_type === 'Supplier') {\n                frm.set_df_property('party', 'options', 'Supplier');\n            } else if (frm.doc.party_type === 'Employee') {\n                frm.set_df_property('party', 'options', 'Employee');\n            }\n        }\n    },\n\n    party: function(frm) {\n        if (frm.doc.party_type === 'Expenses' && frm.doc.party) {\n            // Party Name ni o'rnatish\n            frm.set_value('party_name', frm.doc.party);\n\n            // Expense Account ni olish va Paid To ga qo'yish\n            frappe.db.get_value('Expense Category', frm.doc.party, 'expense_account', (r) => {\n                if (r && r.expense_account) {\n                    frm.set_value('paid_to', r.expense_account);\n                }\n            });\n        }\n    }\n});",
  "view": "Form"
 }
]