[
  {
    "docstatus": 0,
    "doctype": "Client Script",
    "dt": "Stock Entry",
    "enabled": 1,
    "modified": "2026-01-09 13:40:00",
    "module": "Premier Print",
    "name": "Stock Entry - Premier Print Transfer Logic",
    "script": "/**\n * Stock Entry Custom Logic for Premier Print\n * \n * SCENARIOS:\n * 1. \"Расход по заказу\" - Material issue for Sales Order (prices hidden)\n * 2. \"Услуги по заказу\" - Service material issue with editable prices  \n * 3. \"Перемещение\" - Inter-company transfers with SMART warehouse filtering\n *\n * WAREHOUSE LOGIC for \"Перемещение\":\n * - s_warehouse: ONLY from doc.company (filtered)\n * - t_warehouse: NO FILTER - all warehouses from all companies!\n */\n\nfrappe.ui.form.on('Stock Entry', {\n    onload: function(frm) {\n        // Filter stock_entry_type to show only our custom types\n        frm.set_query('stock_entry_type', function() {\n            return {\n                filters: {\n                    name: ['in', ['Расход по заказу', 'Услуги по заказу', 'Перемещение']]\n                }\n            };\n        });\n\n        // Set custom query for Sales Order Item\n        frm.set_query('custom_sales_order_item', function() {\n            if (!frm.doc.custom_sales_order) {\n                return { filters: { name: ['=', ''] } };\n            }\n            return {\n                query: 'premierprint.utils.stock_entry.get_sales_order_items_query',\n                filters: { parent: frm.doc.custom_sales_order }\n            };\n        });\n    },\n\n    refresh: function(frm) {\n        apply_ui_rules(frm);\n        setup_warehouse_filters(frm);\n\n        // Add BOM button for \"Расход по заказу\"\n        if (frm.doc.stock_entry_type === 'Расход по заказу' && \n            frm.doc.custom_sales_order_item && \n            frm.doc.docstatus === 0) {\n            frm.add_custom_button(__('Load BOM Materials'), function() {\n                load_bom_materials(frm);\n            });\n        }\n    },\n\n    stock_entry_type: function(frm) {\n        apply_ui_rules(frm);\n        setup_warehouse_filters(frm);\n    },\n\n    company: function(frm) {\n        setup_warehouse_filters(frm);\n    },\n\n    custom_sales_order: function(frm) {\n        if (!frm.doc.custom_sales_order) {\n            frm.set_value('custom_sales_order_item', '');\n        }\n    }\n});\n\n// Items table events\nfrappe.ui.form.on('Stock Entry Detail', {\n    items_add: function(frm, cdt, cdn) {\n        setup_warehouse_filters(frm);\n    }\n});\n\n/**\n * Apply UI rules based on stock_entry_type\n */\nfunction apply_ui_rules(frm) {\n    const type = frm.doc.stock_entry_type;\n\n    // ============ ALWAYS HIDE DEPRECATED FIELDS ============\n    // These fields are no longer used - hiding them regardless of type\n    if (frm.fields_dict.custom_from_sub_company) {\n        frm.set_df_property('custom_from_sub_company', 'hidden', 1);\n        frm.set_df_property('custom_from_sub_company', 'reqd', 0);\n    }\n    if (frm.fields_dict.custom_to_sub_company) {\n        frm.set_df_property('custom_to_sub_company', 'hidden', 1);\n        frm.set_df_property('custom_to_sub_company', 'reqd', 0);\n    }\n\n    // ============ SCENARIO-SPECIFIC LOGIC ============\n    if (type === 'Расход по заказу') {\n        // Scenario A: Sales Order expense\n        frm.set_df_property('custom_sales_order', 'hidden', 0);\n        frm.set_df_property('custom_sales_order', 'reqd', 1);\n        frm.set_df_property('custom_sales_order_item', 'hidden', 0);\n        frm.set_df_property('custom_supplier', 'hidden', 1);\n        frm.set_df_property('custom_supplier', 'reqd', 0);\n\n        // Hide price fields completely\n        toggle_price_fields(frm, true, false);\n\n    } else if (type === 'Услуги по заказу') {\n        // Scenario B: Service with supplier\n        frm.set_df_property('custom_sales_order', 'hidden', 0);\n        frm.set_df_property('custom_sales_order', 'reqd', 0);\n        frm.set_df_property('custom_sales_order_item', 'hidden', 0);\n        frm.set_df_property('custom_supplier', 'hidden', 0);\n        frm.set_df_property('custom_supplier', 'reqd', 1);\n\n        // Show price fields (editable)\n        toggle_price_fields(frm, false, true);\n\n    } else if (type === 'Перемещение') {\n        // Scenario C: Inter-company transfer\n        // HIDE all custom fields - only use standard company + warehouses\n        frm.set_df_property('custom_sales_order', 'hidden', 1);\n        frm.set_df_property('custom_sales_order', 'reqd', 0);\n        frm.set_df_property('custom_sales_order_item', 'hidden', 1);\n        frm.set_df_property('custom_supplier', 'hidden', 1);\n        frm.set_df_property('custom_supplier', 'reqd', 0);\n\n        // Show price fields (read-only)\n        toggle_price_fields(frm, false, false);\n\n    } else {\n        // Default: hide all custom fields\n        frm.set_df_property('custom_sales_order', 'hidden', 1);\n        frm.set_df_property('custom_sales_order', 'reqd', 0);\n        frm.set_df_property('custom_sales_order_item', 'hidden', 1);\n        frm.set_df_property('custom_supplier', 'hidden', 1);\n        frm.set_df_property('custom_supplier', 'reqd', 0);\n\n        toggle_price_fields(frm, false, false);\n    }\n\n    frm.refresh_fields();\n}\n\n/**\n * Toggle price fields visibility and editability\n */\nfunction toggle_price_fields(frm, hide_completely, editable) {\n    const grid = frm.fields_dict.items?.grid;\n    if (!grid) return;\n\n    if (hide_completely) {\n        grid.update_docfield_property('basic_rate', 'hidden', 1);\n        grid.update_docfield_property('basic_rate', 'read_only', 1);\n        grid.update_docfield_property('amount', 'hidden', 1);\n        grid.update_docfield_property('basic_amount', 'hidden', 1);\n        grid.update_docfield_property('valuation_rate', 'hidden', 1);\n    } else {\n        grid.update_docfield_property('basic_rate', 'hidden', 0);\n        grid.update_docfield_property('amount', 'hidden', 0);\n        grid.update_docfield_property('basic_amount', 'hidden', 0);\n\n        if (editable) {\n            grid.update_docfield_property('basic_rate', 'read_only', 0);\n        } else {\n            grid.update_docfield_property('basic_rate', 'read_only', 1);\n        }\n    }\n\n    grid.refresh();\n}\n\n/**\n * Setup warehouse filters based on stock_entry_type\n * \n * For \"Перемещение\":\n * - s_warehouse: ONLY from doc.company\n * - t_warehouse: NO FILTER (all companies!)\n */\nfunction setup_warehouse_filters(frm) {\n    const type = frm.doc.stock_entry_type;\n    const grid = frm.fields_dict.items?.grid;\n    \n    if (!grid) return;\n\n    if (type === 'Перемещение') {\n        // ========== ПЕРЕМЕЩЕНИЕ FILTERS ==========\n        \n        // Source warehouse: ONLY from selected company\n        grid.get_field('s_warehouse').get_query = function(doc, cdt, cdn) {\n            return {\n                filters: {\n                    company: frm.doc.company,\n                    is_group: 0\n                }\n            };\n        };\n\n        // Target warehouse: NO FILTER! All warehouses from all companies\n        grid.get_field('t_warehouse').get_query = function(doc, cdt, cdn) {\n            return {\n                filters: {\n                    is_group: 0\n                }\n            };\n        };\n\n        // Also set header-level warehouse filters\n        frm.set_query('from_warehouse', function() {\n            return {\n                filters: {\n                    company: frm.doc.company,\n                    is_group: 0\n                }\n            };\n        });\n\n        frm.set_query('to_warehouse', function() {\n            return {\n                filters: {\n                    is_group: 0\n                }\n            };\n        });\n\n    } else {\n        // ========== OTHER TYPES: Filter both by company ==========\n        grid.get_field('s_warehouse').get_query = function(doc, cdt, cdn) {\n            return {\n                filters: {\n                    company: frm.doc.company,\n                    is_group: 0\n                }\n            };\n        };\n\n        grid.get_field('t_warehouse').get_query = function(doc, cdt, cdn) {\n            return {\n                filters: {\n                    company: frm.doc.company,\n                    is_group: 0\n                }\n            };\n        };\n    }\n}\n\n/**\n * Load BOM materials into items table\n */\nfunction load_bom_materials(frm) {\n    if (!frm.doc.custom_sales_order_item) {\n        frappe.msgprint(__('Please select Sales Order Item first'));\n        return;\n    }\n\n    frappe.call({\n        method: 'premierprint.utils.stock_entry.get_bom_materials',\n        args: { sales_order_item: frm.doc.custom_sales_order_item },\n        freeze: true,\n        freeze_message: __('Loading BOM materials...'),\n        callback: function(r) {\n            if (r.message && r.message.length > 0) {\n                frm.clear_table('items');\n\n                r.message.forEach(item => {\n                    let row = frm.add_child('items');\n                    row.item_code = item.item_code;\n                    row.item_name = item.item_name;\n                    row.qty = item.qty;\n                    row.uom = item.uom;\n                    row.stock_uom = item.stock_uom;\n                    row.conversion_factor = item.conversion_factor;\n                    row.description = item.description;\n\n                    if (frm.doc.from_warehouse) {\n                        row.s_warehouse = frm.doc.from_warehouse;\n                    }\n                });\n\n                frm.refresh_field('items');\n                frappe.show_alert({\n                    message: __('BOM materials loaded: {0} items', [r.message.length]),\n                    indicator: 'green'\n                });\n            } else {\n                frappe.msgprint(__('BOM topilmadi. Materiallarni qo\\'lda kiriting.'));\n            }\n        }\n    });\n}",
    "view": "Form"
  },
  {
    "docstatus": 0,
    "doctype": "Client Script",
    "dt": "Purchase Order",
    "enabled": 1,
    "modified": "2025-12-16 17:45:03.598740",
    "module": "Primier Print",
    "name": "Purchase Order",
    "script": "frappe.ui.form.on(\"Purchase Order\", {\n    before_save(frm) {\n        (frm.doc.items || []).forEach(row => {\n            if (!row.schedule_date) {\n                row.schedule_date = frappe.datetime.get_today();\n            }\n        });\n    },\n\n    refresh(frm) {\n        if (frm.fields_dict.items?.grid) {\n            const grid = frm.fields_dict.items.grid;\n\n            // faqat yashiramiz\n            grid.update_docfield_property(\"schedule_date\", \"hidden\", 1);\n            grid.update_docfield_property(\"schedule_date\", \"reqd\", 0);\n\n            grid.refresh();\n        }\n    }\n});\n\n",
    "view": "Form"
  }
]